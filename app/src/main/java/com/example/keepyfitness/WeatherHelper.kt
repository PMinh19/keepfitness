package com.example.keepyfitness.utils

import android.Manifest
import android.content.Context
import android.content.pm.PackageManager
import androidx.core.content.ContextCompat
import com.google.android.gms.location.FusedLocationProviderClient
import com.google.android.gms.location.LocationServices
import okhttp3.*
import org.json.JSONObject
import java.io.IOException

class WeatherHelper(private val context: Context, private val apiKey: String) {

    private val fusedLocationClient: FusedLocationProviderClient =
        LocationServices.getFusedLocationProviderClient(context)

    private val client = OkHttpClient()

    fun getWeatherSuggestion(callback: (String) -> Unit) {
        // ‚úÖ Ki·ªÉm tra quy·ªÅn tr∆∞·ªõc khi g·ªçi GPS
        if (ContextCompat.checkSelfPermission(
                context,
                Manifest.permission.ACCESS_FINE_LOCATION
            ) != PackageManager.PERMISSION_GRANTED
        ) {
            callback("‚ùå Ch∆∞a c√≥ quy·ªÅn v·ªã tr√≠.")
            return
        }

        fusedLocationClient.lastLocation.addOnSuccessListener { location ->
            if (location != null) {
                val lat = location.latitude
                val lon = location.longitude
                val url =
                    "https://api.openweathermap.org/data/2.5/weather?lat=$lat&lon=$lon&appid=$apiKey&units=metric&lang=vi"

                val request = Request.Builder().url(url).build()
                client.newCall(request).enqueue(object : Callback {
                    override fun onFailure(call: Call, e: IOException) {
                        callback("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu th·ªùi ti·∫øt.")
                    }

                    override fun onResponse(call: Call, response: Response) {
                        val data = response.body?.string()
                        if (data != null) {
                            try {
                                val json = JSONObject(data)

                                // check l·ªói API
                                if (json.has("cod") && json.getInt("cod") != 200) {
                                    val msg = json.optString("message", "Kh√¥ng l·∫•y ƒë∆∞·ª£c th·ªùi ti·∫øt")
                                    callback("‚ùå L·ªói API: $msg")
                                    return
                                }

                                // parse b√¨nh th∆∞·ªùng
                                val weather = json.getJSONArray("weather")
                                    .getJSONObject(0)
                                    .getString("main")

                                val suggestion = when (weather) {
                                    "Rain", "Thunderstorm", "Drizzle" ->
                                        "üåßÔ∏è Tr·ªùi m∆∞a ‚Äì h√£y t·∫≠p trong nh√†: Plank, Squat."

                                    "Clear" ->
                                        "‚òÄÔ∏è Tr·ªùi ƒë·∫πp ‚Äì ra ngo√†i ch·∫°y b·ªô ho·∫∑c Jumping Jack."

                                    "Clouds" ->
                                        "‚õÖ Tr·ªùi r√¢m m√°t ‚Äì b·∫°n c√≥ th·ªÉ ch·∫°y b·ªô nh·∫π ngo√†i tr·ªùi."

                                    else ->
                                        "‚ö° Th·ªùi ti·∫øt kh√¥ng ·ªïn ƒë·ªãnh ‚Äì ∆∞u ti√™n t·∫≠p trong nh√†."
                                }
                                callback(suggestion)

                            } catch (e: Exception) {
                                e.printStackTrace()
                                callback("‚ùå L·ªói khi ph√¢n t√≠ch d·ªØ li·ªáu th·ªùi ti·∫øt.")
                            }
                        } else {
                            callback("Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu th·ªùi ti·∫øt.")
                        }
                    }

                })
            }
        }
    }
}
