package com.example.keepyfitness.utils

import android.Manifest
import android.annotation.SuppressLint
import android.content.Context
import android.content.pm.PackageManager
import androidx.core.content.ContextCompat
import com.google.android.gms.location.*
import okhttp3.*
import org.json.JSONObject
import java.io.IOException

class WeatherHelper(private val context: Context, private val apiKey: String) {

    private val fusedLocationClient: FusedLocationProviderClient =
        LocationServices.getFusedLocationProviderClient(context)

    private val client = OkHttpClient()

    @SuppressLint("MissingPermission")
    fun getWeatherSuggestion(callback: (String) -> Unit) {
        // Ki·ªÉm tra quy·ªÅn
        if (ContextCompat.checkSelfPermission(
                context,
                Manifest.permission.ACCESS_FINE_LOCATION
            ) != PackageManager.PERMISSION_GRANTED
        ) {
            callback("‚ùå Ch∆∞a c√≥ quy·ªÅn v·ªã tr√≠.")
            return
        }

        // L·∫•y lastLocation tr∆∞·ªõc
        fusedLocationClient.lastLocation.addOnSuccessListener { location ->
            if (location != null) {
                fetchWeather(location.latitude, location.longitude, callback)
            } else {
                // N·∫øu null, request location m·ªõi
                fusedLocationClient.getCurrentLocation(
                    Priority.PRIORITY_HIGH_ACCURACY,
                    null
                ).addOnSuccessListener { newLocation ->
                    if (newLocation != null) {
                        fetchWeather(newLocation.latitude, newLocation.longitude, callback)
                    } else {
                        callback("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠ GPS.")
                    }
                }.addOnFailureListener {
                    callback("‚ùå L·ªói khi l·∫•y v·ªã tr√≠: ${it.message}")
                }
            }
        }.addOnFailureListener {
            callback("‚ùå L·ªói khi l·∫•y v·ªã tr√≠: ${it.message}")
        }
    }

    private fun fetchWeather(lat: Double, lon: Double, callback: (String) -> Unit) {
        val url =
            "https://api.openweathermap.org/data/2.5/weather?lat=$lat&lon=$lon&appid=$apiKey&units=metric&lang=vi"

        val request = Request.Builder().url(url).build()
        client.newCall(request).enqueue(object : Callback {
            override fun onFailure(call: Call, e: IOException) {
                callback("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu th·ªùi ti·∫øt.")
            }

            override fun onResponse(call: Call, response: Response) {
                val data = response.body?.string()
                if (data != null) {
                    try {
                        val json = JSONObject(data)

                        // Ki·ªÉm tra l·ªói API
                        if (json.has("cod") && json.getInt("cod") != 200) {
                            val msg = json.optString("message", "Kh√¥ng l·∫•y ƒë∆∞·ª£c th·ªùi ti·∫øt")
                            callback("‚ùå L·ªói API: $msg")
                            return
                        }

                        // L·∫•y weather v√† nhi·ªát ƒë·ªô
                        val weather = json.getJSONArray("weather")
                            .getJSONObject(0)
                            .getString("main")
                        val temp = json.getJSONObject("main").getDouble("temp") // ¬∞C

                        // Sinh suggestion d·ª±a tr√™n weather + temp
                        val suggestion = when {
                            weather == "Rain" || weather == "Thunderstorm" || weather == "Drizzle" ->
                                "üåßÔ∏è Tr·ªùi m∆∞a ‚Äì t·∫≠p trong nh√†: Plank, Squat."
                            temp < 15 -> "ü•∂ Tr·ªùi l·∫°nh, ∆∞u ti√™n t·∫≠p trong nh√†: Plank, Squat."
                            temp in 15.0..25.0 && weather == "Clear" ->
                                "‚òÄÔ∏è Th·ªùi ti·∫øt m√°t, ra ngo√†i ch·∫°y b·ªô ho·∫∑c Jumping Jack."
                            temp in 15.0..25.0 && weather == "Clouds" ->
                                "‚õÖ Tr·ªùi r√¢m m√°t, ch·∫°y b·ªô nh·∫π ngo√†i tr·ªùi."
                            temp > 30 -> "ü•µ Tr·ªùi n√≥ng, t·∫≠p trong nh√† v√† nh·ªõ u·ªëng ƒë·ªß n∆∞·ªõc ƒë·∫ßy ƒë·ªß."
                            else -> "‚ö° Th·ªùi ti·∫øt kh√¥ng ·ªïn ƒë·ªãnh, ∆∞u ti√™n t·∫≠p trong nh√†."
                        }

                        callback(suggestion)

                    } catch (e: Exception) {
                        e.printStackTrace()
                        callback("‚ùå L·ªói khi ph√¢n t√≠ch d·ªØ li·ªáu th·ªùi ti·∫øt.")
                    }
                } else {
                    callback("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu th·ªùi ti·∫øt.")
                }
            }
        })
    }
}
